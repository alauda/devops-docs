---
weight: 30
sourceSHA: 7eeb629500ae9f7fd483860927b397f9ce1cf644c95889012ee79c0108ea0957
---

## 安装 DevOps Legacy

本指南提供了安装 `Alauda DevOps Legacy` 的详细步骤。

## 前提条件

在继续之前，请确保已安装以下 operator：

- 已安装 `Alauda DevOps v3` operator
- 已安装 `Alauda DevOps Eventing v3` operator

## 部署位置

在 global cluster 中部署 Katanomi 和 KnativeEventing 实例。业务集群可以根据 CI/CD 需求部署实例。

<table>
  <tr>
    <th style={{ whiteSpace: 'nowrap' }}>组件</th>
    <th style={{ whiteSpace: 'nowrap' }}>Global cluster</th>
    <th style={{ whiteSpace: 'nowrap' }}>业务集群</th>
  </tr>
  <tr>
    <td>Katanomi</td>
    <td>已安装</td>
    <td>可选</td>
  </tr>
    <tr>
    <td>KnativeEventing</td>
    <td>已安装</td>
    <td>可选</td>
  </tr>
</table>

## 安装步骤

<Steps>

  ### 创建 Katanomi 实例

  :::warning
  只支持一个 Katanomi 实例。

  - **Global cluster**：在 `cpaas-system` 命名空间中部署。将 `ExternalURL` 设置为 `global` 集群的 `Platform URL`，并将 `Service.Type` 设置为 `Ingress`。
  - **业务集群**：支持在任何命名空间中部署。
  :::

  - 登录 `Alauda Container Platform` 平台。
  - 在 `平台管理` 下导航到 **集群** 标签页。
  - 选择已部署的集群并点击 **CLI 工具**。
  - 对于 `global` 集群，执行以下命令获取 `ExternalURL`：

  ```shell
  export EXTERNAL_URL=$(kubectl get prdb -n cpaas-system base -o jsonpath='{.spec.platformURL}')
  ```

  - 创建 Katanomi 实例（根据需要调整参数）

  ```shell
  cat <<EOF | kubectl apply -f -
  apiVersion: operators.katanomi.dev/v1alpha1
  kind: Katanomi
  metadata:
    name: katanomi
    namespace: cpaas-system
  spec:
    externalURL: ${EXTERNAL_URL}
    replicas: 1
    resources:
      limits:
        cpu: "2"
        memory: 4Gi
      requests:
        cpu: "1"
        memory: 2Gi
    service:
      ingress:
        protocol: HTTP
      type: Ingress
  EOF
  ```

  - 等待 DevOps 实例就绪
  ```shell
  kubectl wait --for='jsonpath={.status.conditions[?(@.type=="Running")].status}=true' katanomis/katanomi -n cpaas-system --timeout=5m
  ```

  ### 创建 KnativeEventing 实例

  :::warning
  只支持一个 KnativeEventing 实例。确保 `default-br-config` 中的命名空间与 KnativeEventing 实例的命名空间匹配。
  :::

  - 登录 `Alauda Container Platform` 平台。
  - 在 `平台管理` 标签页中，点击 **集群** 标签。
  - 选择已部署的集群并点击 **CLI 工具**。
  - 创建 KnativeEventing 实例

  ```shell
  cat <<EOF | kubectl apply -f -
  apiVersion: operator.knative.dev/v1beta1
  kind: KnativeEventing
  metadata:
    name: knative-eventing
    namespace: knative-operator
  spec:
    config:
      config-br-defaults:
        default-br-config: |
          # 集群级别默认 broker 配置
          clusterDefault:
            apiVersion: v1
            kind: ConfigMap
            name: config-br-default-channel
            # configmap 所在的命名空间
            # 必须与 KnativeEventing 实例的命名空间相同！！！
            namespace: knative-operator
  EOF
  ```

  - 等待 KnativeEventing 实例就绪

  ```shell
  kubectl wait --for='jsonpath={.status.conditions[?(@.type=="Ready")].status}=True' knativeeventings/knative-eventing -n knative-operator --timeout=5m
  ```
</Steps>

## Katanomi 参数说明

<table>
  <tr>
    <th style={{ whiteSpace: 'nowrap' }}>参数</th>
    <th style={{ whiteSpace: 'nowrap' }}>说明</th>
  </tr>

  <tr>
    <td><b>Name</b></td>
    <td>
      Katanomi 实例的名称。
    </td>
  </tr>

  <tr>
    <td><b>Namespaces</b></td>
    <td>
      只要命名空间中的资源充足，Katanomi 实例可以部署到任何命名空间。
    </td>
  </tr>

  <tr>
    <td><b>External URL</b></td>
    <td>
      访问地址，即 API 地址。根据 Service Type 的配置进行规划。<br />当 Service Type 为 `Node Port` 时，请输入 `http://<IP>:<Port>`。**Port** 必须与 Service 的 `Node Port` 一致，API 端口用于服务访问。<br />当 Service Type 为 `Ingress` 时，请输入对应的访问地址，例如：`http://kubernetes.io`。
    </td>
  </tr>

  <tr>
    <td><b>Replicas</b></td>
    <td>
      Deployment 的副本数，默认为 2。<br />
      当副本数为 1 时，使用单节点部署。
    </td>
  </tr>

  <tr>
    <td><b>Resources</b></td>
    <td>
      - <b>requests:</b> 工具运行时可以消耗的最小 CPU 和内存资源量。
      - <b>limits:</b> 工具运行时需要占用的最大 CPU 和内存资源量。
    </td>
  </tr>

  <tr>
    <td><b>Service.Type</b></td>
    <td>
      必填字段。提供两种类型：Node Port 和 Ingress。
      - <b>Node Port:</b> 通过静态端口暴露路由，通过 `<IP>:<port>` 访问。
      - <b>Ingress:</b> 通过入站规则暴露路由，通过域名访问。
    </td>
  </tr>

  <tr>
    <td><b>Service.Ingress</b></td>
    <td>
      当 Type 设置为 Ingress 时必填。
      - <b>域名：</b> 用于访问工具的域名。
      - <b>协议：</b> 通过 HTTP 或 HTTPS 访问工具。
      - <b>证书名称：</b> 通过 HTTPS 访问工具时使用的 SSL 证书名称。
    </td>
  </tr>

  <tr>
    <td><b>Service.Node Port</b></td>
    <td>
      当 <b>Type</b> 设置为 <b>Node Port</b> 时必填。用于访问工具的端口号，API Port 和 Plugin Port 不能重复，端口值范围为 30000-32767。
      - <b>API Port:</b> 用于通过 HTTP 访问 Katanomi-api 组件的端口，用于执行工具集成绑定相关操作。
      - <b>Plugin Port:</b> 用于通过 HTTP 访问 Katanomi-plugin 组件的端口，用于在平台中处理工具链集成绑定事件。
    </td>
  </tr>
</table>

## KnativeEventing 参数说明

我们提供的默认参数配置如下：
```yaml
  apiVersion: operator.knative.dev/v1beta1
  kind: KnativeEventing
  metadata:
    name: knative-eventing
    namespace: ${KNATIVE_EVENTING_NAMESPACE}
  spec:
    config:
      config-br-defaults:
        default-br-config: |
          # 集群级别默认 broker 配置
          clusterDefault:
            apiVersion: v1
            kind: ConfigMap
            name: config-br-default-channel
            # configmap 所在的命名空间
            # 必须与 KnativeEventing 实例的命名空间相同！！！
            namespace: ${KNATIVE_EVENTING_NAMESPACE}
```

配置 Knative Eventing CRDs 的详细信息请参考：[https://knative.dev/docs/install/operator/configuring-eventing-cr/](https://knative.dev/docs/install/operator/configuring-eventing-cr/)
