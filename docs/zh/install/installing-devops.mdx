---
weight: 30
sourceSHA: fbe3f01abd323ec04a9a3f1840e748e0b388d1f32b526119ffd57e1720cdd4af
---

# 安装 Alauda DevOps

本指南提供了安装 `Alauda DevOps` 的详细步骤。

## 前提条件

在继续之前，请确保已上传 `Alauda DevOps v3` 操作器。

有关如何上传操作器的更多信息，请参阅 <ExternalSiteLink name="container_platform" href="ui/cli_tools/index.html#uploading-operators" children="上传操作器" />

## 安装操作器

前往平台的 `Administrator` -> `Marketplace` -> `OperatorHub` 页面，搜索 `Alauda DevOps v3`，然后点击操作器卡片进入操作器详情页面。

点击 `Install` 安装操作器。

## 部署位置

在 Global 集群中部署 Katanomi 实例。业务集群可以根据需要部署实例以支持 CI/CD。

<table>
  <tr>
    <th style={{ whiteSpace: 'nowrap' }}>组件</th>
    <th style={{ whiteSpace: 'nowrap' }}>Global Cluster</th>
    <th style={{ whiteSpace: 'nowrap' }}>Business Cluster</th>
  </tr>

  <tr>
    <td>Katanomi</td>
    <td>已安装</td>
    <td>可选</td>
  </tr>
</table>

## 操作步骤

<Steps>
### 创建 Katanomi 实例

:::warning
仅支持一个 Katanomi 实例。

- **Global 集群**：在 `cpaas-system` 命名空间内部署。将 `ExternalURL` 设置为 `global` 集群的 `Platform URL`，并将 `Service.Type` 设置为 `Ingress`。

- **Business 集群**：可以在任何非 `cpaas-system` 的命名空间中进行部署。
  :::

- 登录到 `Alauda Container Platform` 平台。

- 转到 `Platform Management` 下的 **Clusters** 标签。

- 选择已部署的集群并点击 **CLI Tools**。

- 创建 Katanomi 实例（根据需要调整参数）

Global 集群

```bash
export NAMESPACE=cpaas-system
export EXTERNAL_URL=$(kubectl get prdb -n cpaas-system base -o jsonpath='{.spec.platformURL}')
cat <<EOF | kubectl apply -f -
apiVersion: operators.katanomi.dev/v1alpha1
kind: Katanomi
metadata:
  name: katanomi
  namespace: ${NAMESPACE}
spec:
  externalURL: ${EXTERNAL_URL}
  replicas: 1
  resources:
    limits:
      cpu: "2"
      memory: 4Gi
    requests:
      cpu: "1"
      memory: 2Gi
  service:
    ingress:
      protocol: HTTP
    type: Ingress
EOF
```

Business 集群

```bash
export NAMESPACE=katanomi-operator
export NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}' | awk -F" " '{print $1}')
export EXTERNAL_URL=http://${NODE_IP}:32001
cat <<EOF | kubectl apply -f -
apiVersion: operators.katanomi.dev/v1alpha1
kind: Katanomi
metadata:
  name: katanomi
  namespace: ${NAMESPACE}
spec:
  externalURL: ${EXTERNAL_URL}
  replicas: 1
  resources:
    limits:
      cpu: "2"
      memory: 4Gi
    requests:
      cpu: "1"
      memory: 2Gi
  service:
    nodePort:
      apiPort:
        httpPort: 32000
      pluginPort:
        httpPort: 32001
    type: NodePort
EOF
```

- 等待 DevOps 实例准备就绪

```shell
kubectl wait --for='jsonpath={.status.conditions[?(@.type=="Running")].status}=true' katanomis/katanomi -n cpaas-system --timeout=5m
```

### 准备 CI/CD 功能

在开始使用 Alauda DevOps 的构建和发布管道功能之前，平台管理员需要完成一些准备工作。

部署 Alauda DevOps v3 后，请参考平台内部文档：`<Platform URL>/console-devops-docs/en/devops-initialization/cicd/init/`
</Steps>

## Katanomi 参数描述

<table>
  <tr>
    <th style={{ whiteSpace: 'nowrap' }}>参数</th>
    <th style={{ whiteSpace: 'nowrap' }}>描述</th>
  </tr>

  <tr>
    <td><b>Name</b></td>

    <td>
      Katanomi 实例的名称。
    </td>
  </tr>

  <tr>
    <td><b>Namespaces</b></td>

    <td>
      对于 `Business Cluster`，Katanomi 实例可以部署到任意有足够资源的命名空间。对于 `Global Cluster`，Katanomi 实例必须专门部署在 `cpaas-system` 命名空间。
    </td>
  </tr>

  <tr>
    <td><b>External URL</b></td>

    <td>
      访问地址，即 API 地址。请根据 Service Type 的配置进行规划。<br />当 Service Type 为 `Node Port` 时，请输入 `http://<IP>:<Port>`。**Port** 必须与 Service 的 `Node Port` 保持一致，API 端口用于服务访问。<br />当 Service Type 为 `Ingress` 时，请输入相应的访问地址，例如：`http://kubernetes.io`。
    </td>
  </tr>

  <tr>
    <td><b>Replicas</b></td>

    <td>
      部署的副本数量，默认值为 2。<br />
      当副本数量为 1 时，将使用单节点部署。
    </td>
  </tr>

  <tr>
    <td><b>Resources</b></td>

    <td>
      - <b>requests:</b> 运行工具时可以消耗的最小 CPU 和内存资源。
      - <b>limits:</b> 运行工具时需要占用的最大 CPU 和内存资源。
    </td>
  </tr>

  <tr>
    <td><b>Service.Type</b></td>

    <td>
      必填字段。提供两种类型：Node Port 和 Ingress。

      - <b>Node Port:</b> 通过静态端口暴露路由，访问地址为 `<IP>:<port>`。
      - <b>Ingress:</b> 通过入站规则暴露路由，访问地址为域名。
    </td>
  </tr>

  <tr>
    <td><b>Service.Ingress</b></td>

    <td>
      如果 Type 设置为 Ingress，则必需。

      - <b>Domain Name:</b> 用于访问该工具的域名。
      - <b>Protocol:</b> 通过 HTTP 或 HTTPS 访问工具。
      - <b>Secret Name:</b> 用于通过 HTTPS 访问工具时使用的 SSL 证书名称。
    </td>
  </tr>

  <tr>
    <td><b>Service.Node Port</b></td>

    <td>
      如果 <b>Type</b> 设置为 <b>Node Port</b> 则必需。用于访问工具的端口号，API Port 和 Plugin Port 不能重复，端口值范围为 30000-32767。

      - <b>API Port:</b> 用于通过 HTTP 访问 Katanomi-api 组件的端口，执行工具集成绑定相关操作。
      - <b>Plugin Port:</b> 用于通过 HTTP 访问 Katanomi-plugin 组件的端口，在平台中处理工具链集成绑定事件。
    </td>
  </tr>
</table>

## 常见问题

#### Katanomi Pod 因只读根文件系统启动失败：/cpaas 目录不可写

Katanomi 需要对主机系统上的 /cpaas 目录具有写权限以存储审计日志。如果 pod 不能写入此目录，则无法启动。

为解决此问题，您可以配置备用的审计日志存储路径。例如：

```yaml
spec:
  helmValues:
    api:
      auditHostPath: /tmp/audit
    devopsApiServer:
      auditHostPath: /tmp/audit
    devopsApi:
      auditHostPath: /tmp/audit
```

此配置指示 Katanomi 组件使用 /tmp/audit 作为审计日志存储路径，以确保与强制只读根文件系统的环境兼容。根据需要调整路径，以满足您的安全和操作要求。

#### 如何在部署 Katanomi 时配置自定义 ImagePullSecret

要为您的 Katanomi 实例指定自定义 ImagePullSecret，添加以下配置：

```yaml
spec:
  helmValues:
    global:
      registry:
        imagePullSecret:
          name: <imagePullSecretName>
```

此配置确保 Katanomi 使用指定的 ImagePullSecret 从私有注册表中拉取容器镜像。将 `imagePullSecretName` 替换为您预先创建的包含所需注册凭证的 Kubernetes 秘密名称。
