---
weight: 30
sourceSHA: fbe3f01abd323ec04a9a3f1840e748e0b388d1f32b526119ffd57e1720cdd4af
---

# Установка Alauda DevOps

Это руководство содержит подробные шаги для установки `Alauda DevOps`.

## Предварительные условия

Убедитесь, что оператор `Alauda DevOps v3` загружен перед продолжением.

Для получения дополнительной информации о загрузке оператора, пожалуйста, обратитесь к <ExternalSiteLink name="container_platform" href="ui/cli_tools/index.html#uploading-operators" children="Загрузка операторов" />

## Установка оператора

Перейдите на страницу `Администратор` -> `Marketplace` -> `OperatorHub`, найдите `Alauda DevOps v3` и затем нажмите на карточку оператора, чтобы войти на страницу деталей оператора.

Нажмите `Установить`, чтобы установить оператор.

## Место развертывания

Развертывайте экземпляры Katanomi в Глобальном кластере. Бизнес-кластер может развертывать экземпляры по мере необходимости для CI/CD.

<table>
  <tr>
    <th style={{ whiteSpace: 'nowrap' }}>Компонент</th>
    <th style={{ whiteSpace: 'nowrap' }}>Глобальный кластер</th>
    <th style={{ whiteSpace: 'nowrap' }}>Бизнес-кластер</th>
  </tr>

  <tr>
    <td>Katanomi</td>
    <td>Установлен</td>
    <td>По желанию</td>
  </tr>
</table>

## Процедура

<Steps>
### Создание экземпляра Katanomi

:::warning
Поддерживается только один экземпляр Katanomi.

- **Глобальный кластер**: Развернуть в пространстве имен `cpaas-system`. Установите `ExternalURL` на `Platform URL` глобального кластера и `Service.Type` на `Ingress`.

- **Бизнес кластер**: Может быть развернут в любом пространстве имен, кроме `cpaas-system`.
  :::

- Войдите на платформу `Alauda Container Platform`.

- Перейдите на вкладку **Кластеры** в разделе `Управление платформой`.

- Выберите развернутый кластер и нажмите **CLI Tools**.

- Создайте экземпляр Katanomi (при необходимости отрегулируйте параметры)

Глобальный кластер

```shell
export NAMESPACE=cpaas-system
export EXTERNAL_URL=$(kubectl get prdb -n cpaas-system base -o jsonpath='{.spec.platformURL}')
cat <<EOF | kubectl apply -f -
apiVersion: operators.katanomi.dev/v1alpha1
kind: Katanomi
metadata:
  name: katanomi
  namespace: ${NAMESPACE}
spec:
  externalURL: ${EXTERNAL_URL}
  replicas: 1
  resources:
    limits:
      cpu: "2"
      memory: 4Gi
    requests:
      cpu: "1"
      memory: 2Gi
  service:
    ingress:
      protocol: HTTP
    type: Ingress
EOF
```

Бизнес кластер

```shell
export NAMESPACE=katanomi-operator
export NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}' | awk -F" " '{print $1}')
export EXTERNAL_URL=http://${NODE_IP}:32001
cat <<EOF | kubectl apply -f -
apiVersion: operators.katanomi.dev/v1alpha1
kind: Katanomi
metadata:
  name: katanomi
  namespace: ${NAMESPACE}
spec:
  externalURL: ${EXTERNAL_URL}
  replicas: 1
  resources:
    limits:
      cpu: "2"
      memory: 4Gi
    requests:
      cpu: "1"
      memory: 2Gi
  service:
    nodePort:
      apiPort:
        httpPort: 32000
      pluginPort:
        httpPort: 32001
    type: NodePort
EOF
```

- Дождитесь, пока экземпляр DevOps будет готов

```shell
kubectl wait --for='jsonpath={.status.conditions[?(@.type=="Running")].status}=true' katanomis/katanomi -n cpaas-system --timeout=5m
```

### Подготовка к функциональности CI/CD

Перед началом использования возможностей сборки и выпуска Alauda DevOps администраторам платформы необходимо завершить некоторые подготовительные работы.

Обратитесь к документации в платформе после развертывания Alauda DevOps v3: `<Platform URL>/console-devops-docs/en/devops-initialization/cicd/init/`

</Steps>

## Описание параметров Katanomi

<table>
  <tr>
    <th style={{ whiteSpace: 'nowrap' }}>Параметр</th>
    <th style={{ whiteSpace: 'nowrap' }}>Описание</th>
  </tr>

  <tr>
    <td><b>Имя</b></td>

    <td>
      Имя экземпляра Katanomi.
    </td>
  </tr>

  <tr>
    <td><b>Пространства имен</b></td>

    <td>
      Для `бизнес кластеров`, экземпляр Katanomi может быть развернут в любом пространстве имен при наличии достаточных ресурсов. Для `глобального кластера` экземпляр Katanomi должен быть развернут исключительно в пространстве имен `cpaas-system`.
    </td>
  </tr>

  <tr>
    <td><b>Внешний URL</b></td>

    <td>
      Адрес доступа, который является адресом API. Планируйте в соответствии с конфигурацией типа службы.<br />Когда тип службы `Node Port`, пожалуйста, введите `http://<IP>:<Port>`. **Порт** должен соответствовать `Node Port` службы, а API-порт используется для доступа к службе.<br />Когда тип службы `Ingress`, пожалуйста, введите соответствующий адрес доступа, например: `http://kubernetes.io`.
    </td>
  </tr>

  <tr>
    <td><b>Реплики</b></td>

    <td>
      Количество реплик для развертывания, по умолчанию 2. <br />
      Когда количество реплик равно 1, используется одноузловое развертывание.
    </td>
  </tr>

  <tr>
    <td><b>Ресурсы</b></td>

    <td>
      - <b>requests:</b> Минимальное количество ресурсов CPU и памяти, которые могут быть использованы при запуске инструмента.
      - <b>limits:</b> Максимальное количество ресурсов CPU и памяти, которые необходимо занять при запуске инструмента.
    </td>
  </tr>

  <tr>
    <td><b>Service.Type</b></td>

    <td>
      Обязательное поле. Предоставляет два типа: Node Port и Ingress.

      - <b>Node Port:</b> Открывает маршрут через статический порт, доступный по адресу `<IP>:<port>`.
      - <b>Ingress:</b> Открывает маршрут через входящие правила, доступный по доменному имени.
    </td>
  </tr>

  <tr>
    <td><b>Service.Ingress</b></td>

    <td>
      Требуется, если тип установлен в Ingress.

      - <b>Доменное имя:</b> Доменное имя, используемое для доступа к инструменту.
      - <b>Протокол:</b> Доступ к инструменту через HTTP или HTTPS.
      - <b>Имя секрета:</b> Имя SSL-сертификата, используется при доступе к инструменту через HTTPS.
    </td>
  </tr>

  <tr>
    <td><b>Service.Node Port</b></td>

    <td>
      Требуется, если <b>Type</b> установлен в <b>Node Port</b>. Номер порта, используемый для доступа к инструменту; API-порт и порт плагина не могут дублироваться, и диапазон значений порта составляет 30000-32767.

      - <b>API Port:</b> Порт, используемый для доступа к компоненту Katanomi-api через HTTP, который используется для выполнения операций, связанных с интеграцией инструментов.
      - <b>Plugin Port:</b> Порт, используемый для доступа к компоненту Katanomi-plugin через HTTP, который используется на платформе для обработки событий интеграции инструментов.
    </td>
  </tr>
</table>

## Часто задаваемые вопросы

#### Кластер Katanomi не может быть запущен из-за только для чтения корневой файловой системы: директория /cpaas не доступна для записи

Katanomi требует права на запись в директорию /cpaas на хост-системе для хранения журналов аудита. Если под не может записывать в эту директорию, он не сможет запуститься.

Чтобы решить эту проблему, вы можете настроить альтернативный путь хранения журналов аудита. Например:

```yaml
spec:
  helmValues:
    api:
      auditHostPath: /tmp/audit
    devopsApiServer:
      auditHostPath: /tmp/audit
    devopsApi:
      auditHostPath: /tmp/audit
```

Эта конфигурация направляет компоненты Katanomi использовать /tmp/audit в качестве пути хранения журналов аудита, обеспечивая совместимость с окружениями, которые требуют только для чтения корневую файловую систему. Настройте путь по мере необходимости в соответствии с вашими требованиями безопасности и эксплуатации.

#### Как настроить пользовательский ImagePullSecret при развертывании Katanomi

Чтобы указать пользовательский ImagePullSecret для вашего экземпляра Katanomi, добавьте следующую конфигурацию:

```yaml
spec:
  helmValues:
    global:
      registry:
        imagePullSecret:
          name: <imagePullSecretName>
```

Эта конфигурация гарантирует, что Katanomi использует указанный ImagePullSecret для получения контейнерных образов из частных реестров. Замените `imagePullSecretName` на имя вашего ранее созданного секрета Kubernetes, содержащего необходимые учетные данные реестра.
